import"./modulepreload-polyfill-B5Qt9EMX.js";import{O as s,C as h,a as d,b as M,c as E,d as A}from"./bsConstants-D5aU1hWn.js";function U(c){return c.type==="IMAGE"}class u{static PLAYER="PLAYER";static PARTY="PARTY";static LOCALITEMS="LOCALITEMS";static SCENEITEMS="SCENEITEMS";static SCENEMETA="SCENEMETADATA";static SCENEGRID="SCENEGRID";static ROOMMETA="ROOMMETADATA";debouncedOnSceneItemsChange;debouncedOnSceneMetadataChange;debouncedOnPartyChange;playerId;playerConnection;playerColor;playerName;playerMetadata;playerRole;currentDealer;party;lastParty;gridDpi;gridScale;sceneItems;sceneSelected;sceneMetadata;sceneReady;activeCards;activeDecks;roomMetadata;theme;caches;USER_REGISTERED;historyLog;sceneMetadataHandler;localItemsHandler;sceneItemsHandler;sceneGridHandler;sceneReadyHandler;playerHandler;partyHandler;themeHandler;roomHandler;constructor(e){this.playerId="",this.playerConnection="",this.playerName="",this.playerColor="",this.playerMetadata={},this.playerRole="PLAYER",this.currentDealer="",this.party=[],this.lastParty=[],this.sceneItems=[],this.sceneSelected=[],this.sceneMetadata={},this.activeCards=[],this.activeDecks=[],this.gridDpi=0,this.gridScale=5,this.sceneReady=!1,this.theme="DARK",this.roomMetadata={},this.USER_REGISTERED=!1,this.caches=e,this.historyLog={},this.debouncedOnSceneItemsChange=T(this.OnSceneItemsChange.bind(this),100),this.debouncedOnSceneMetadataChange=T(this.OnSceneMetadataChanges.bind(this),100),this.debouncedOnPartyChange=T(this.OnPartyChange.bind(this),100)}async InitializeCache(){this.sceneReady=await s.scene.isReady(),this.theme=await s.theme.getTheme(),H(this.theme,document),this.caches.includes(u.PLAYER)&&(this.playerId=await s.player.getId(),this.playerConnection=await s.player.getConnectionId(),this.playerName=await s.player.getName(),this.playerColor=await s.player.getColor(),this.playerMetadata=await s.player.getMetadata(),this.playerRole=await s.player.getRole()),this.caches.includes(u.PARTY)&&(this.party=await s.party.getPlayers(),this.lastParty=this.party),this.caches.includes(u.SCENEITEMS)&&this.sceneReady&&(this.sceneItems=await s.scene.items.getItems()),this.caches.includes(u.SCENEMETA)&&this.sceneReady&&(this.sceneMetadata=await s.scene.getMetadata()),this.caches.includes(u.SCENEGRID)&&this.sceneReady&&(this.gridDpi=await s.scene.grid.getDpi(),this.gridScale=(await s.scene.grid.getScale()).parsed?.multiplier??5),this.caches.includes(u.ROOMMETA)&&(this.roomMetadata=await s.room.getMetadata(),await this.RefreshDealer())}KillHandlers(){this.caches.includes(u.SCENEMETA)&&this.sceneMetadataHandler!==void 0&&this.sceneMetadataHandler(),this.caches.includes(u.SCENEITEMS)&&this.sceneItemsHandler!==void 0&&this.sceneItemsHandler(),this.caches.includes(u.SCENEITEMS)&&this.localItemsHandler!==void 0&&this.localItemsHandler(),this.caches.includes(u.SCENEGRID)&&this.sceneGridHandler!==void 0&&this.sceneGridHandler(),this.caches.includes(u.PLAYER)&&this.playerHandler!==void 0&&this.playerHandler(),this.caches.includes(u.PARTY)&&this.partyHandler!==void 0&&this.partyHandler(),this.caches.includes(u.ROOMMETA)&&this.roomHandler!==void 0&&this.roomHandler(),this.themeHandler!==void 0&&this.themeHandler()}SetupHandlers(){(this.sceneMetadataHandler===void 0||this.sceneMetadataHandler.length===0)&&this.caches.includes(u.SCENEMETA)&&(this.sceneMetadataHandler=s.scene.onMetadataChange(async e=>{this.sceneMetadata=e,this.debouncedOnSceneMetadataChange(e)})),(this.sceneItemsHandler===void 0||this.sceneItemsHandler.length===0)&&this.caches.includes(u.SCENEITEMS)&&(this.sceneItemsHandler=s.scene.items.onChange(async e=>{this.sceneItems=e,this.debouncedOnSceneItemsChange(e)})),(this.sceneGridHandler===void 0||this.sceneGridHandler.length===0)&&this.caches.includes(u.SCENEGRID)&&(this.sceneGridHandler=s.scene.grid.onChange(async e=>{this.gridDpi=e.dpi,this.gridScale=parseInt(e.scale),await this.OnSceneGridChange(e)})),(this.playerHandler===void 0||this.playerHandler.length===0)&&this.caches.includes(u.PLAYER)&&(this.playerHandler=s.player.onChange(async e=>{this.playerName=e.name,this.playerColor=e.color,this.playerId=e.id,this.playerConnection=e.connectionId,this.playerRole=e.role,this.playerMetadata=e.metadata,await this.OnPlayerChange(e)})),(this.partyHandler===void 0||this.partyHandler.length===0)&&this.caches.includes(u.PARTY)&&(this.partyHandler=s.party.onChange(async e=>{this.party=e.filter(a=>a.id!==""),this.debouncedOnPartyChange(e)})),(this.roomHandler===void 0||this.roomHandler.length===0)&&this.caches.includes(u.ROOMMETA)&&(this.roomHandler=s.room.onMetadataChange(async e=>{this.roomMetadata=e,await this.OnRoomMetadataChange(e)})),this.themeHandler===void 0&&(this.themeHandler=s.theme.onChange(async e=>{this.theme=e.mode,await this.OnThemeChange(e)})),this.sceneReadyHandler===void 0&&(this.sceneReadyHandler=s.scene.onReadyChange(async e=>{this.sceneReady=e,e&&(this.sceneItems=await s.scene.items.getItems(U),this.sceneMetadata=await s.scene.getMetadata(),this.gridDpi=await s.scene.grid.getDpi(),this.gridScale=(await s.scene.grid.getScale()).parsed?.multiplier??5),await this.OnSceneReadyChange(e)}))}async OnSceneMetadataChanges(e){this.playerRole}async OnLocalItemsChange(e){}async OnSceneItemsChange(e){if(this.sceneReady&&this.playerId===this.currentDealer){this.activeCards=this.sceneItems.filter(t=>t.metadata[`${h.EXTENSIONID}/card_data`]!==void 0),this.activeDecks=this.sceneItems.filter(t=>t.metadata[`${h.EXTENSIONID}/deck_data`]!==void 0);const a=[];for(const t of this.activeDecks){for(const i of this.activeCards)if(N(i.position,t.position,25)){const r=i.zIndex>t.zIndex,n=i.metadata[`${h.EXTENSIONID}/card_data`];n.FaceUp=!1,await s.scene.items.updateItems(m=>m.id===t.id,m=>{for(let p of m){const l=p.metadata[`${h.EXTENSIONID}/deck_data`];r?l.Cards.push(n):l.Cards.unshift(n);const I=r?l.Cards[l.Cards.length-1]:l.Cards[0],C=y(I.BackUrl);p.image.url=I.BackUrl,p.image.mime=`image/${C}`,p.text.plainText=l.Cards.length.toString()}}),a.push(i.id)}for(const i of this.activeDecks){if(i.id===t.id||a.includes(t.id))continue;if(N(i.position,t.position,25)){const r=i.zIndex>t.zIndex,n=t.metadata[`${h.EXTENSIONID}/deck_data`],m=i.metadata[`${h.EXTENSIONID}/deck_data`];await s.scene.items.updateItems(l=>l.id===t.id,l=>{for(let I of l){const C=I.metadata[`${h.EXTENSIONID}/deck_data`],g=r?[...C.Cards,...m.Cards]:[...m.Cards,...C.Cards];C.Cards=g;const D=r?C.Cards[C.Cards.length-1]:C.Cards[0],x=y(D.BackUrl);I.image.url=D.BackUrl,I.image.mime=`image/${x}`,I.text.plainText=C.Cards.length.toString()}});const p=k.sceneItems.find(l=>l.attachedTo===t.id&&l.metadata[`${h.EXTENSIONID}/deck_id_lines`]!==void 0);await s.scene.items.updateItems(l=>l.id===p.id,l=>{for(let I of l)I.position={x:t.position.x,y:t.position.y+Math.min(n.Cards.length+m.Cards.length,75)}}),a.push(i.id)}}}a.length>0&&await s.scene.items.deleteItems(a)}}async OnSceneGridChange(e){}async OnSceneReadyChange(e){}async OnPlayerChange(e){e.selection?.length}async OnPartyChange(e){e.length!==this.lastParty.length&&await this.RefreshDealer(),this.lastParty=e,console.log(e)}async OnRoomMetadataChange(e){}async OnThemeChange(e){H(e,document)}async RefreshDealer(){this.currentDealer=this.roomMetadata[`${h.EXTENSIONID}/dealer`];const e=this.currentDealer===this.playerId,a=this.party.find(t=>t.id===this.currentDealer);(!this.currentDealer||!e&&!a)&&await s.room.setMetadata({[`${h.EXTENSIONID}/dealer`]:this.playerId})}}const k=new u([u.PLAYER,u.PARTY,u.SCENEITEMS,u.SCENEMETA,u.ROOMMETA]);function S(c,e){return c=Math.ceil(c),e=Math.floor(e),Math.floor(Math.random()*(e-c+1))+c}function R(){let c=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=(c+Math.random()*16)%16|0;return c=Math.floor(c/16),(a==="x"?t:t&3|8).toString(16)})}function N(c,e,a){const t=c.x-e.x,i=c.y-e.y;return Math.sqrt(t*t+i*i)<=a}function w(c){for(let e=c.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[c[e],c[a]]=[c[a],c[e]]}return c}function y(c){const t=new URL(c).pathname.split(".").pop();return t||""}function T(c,e){let a;return function(...i){a&&clearTimeout(a),a=setTimeout(()=>{c(...i),a=void 0},e)}}function H(c,e){const a=window.matchMedia("(prefers-color-scheme: dark)"),t=a.matches?"dark":"light",i=a.matches?"light":"dark";for(var o=0;o<e.styleSheets.length;o++)for(var r=0;r<e.styleSheets[o].cssRules.length;r++){let n=e.styleSheets[o].cssRules[r];n&&n.media&&n.media.mediaText.includes("prefers-color-scheme")&&(c.mode=="LIGHT"?(n.media.appendMedium(`(prefers-color-scheme: ${t})`),n.media.mediaText.includes(i)&&n.media.deleteMedium(`(prefers-color-scheme: ${i})`)):c.mode=="DARK"&&(n.media.appendMedium(`(prefers-color-scheme: ${i})`),n.media.mediaText.includes(t)&&n.media.deleteMedium(`(prefers-color-scheme: ${t})`)))}}async function v(){await s.contextMenu.create({id:h.CUTCARDSID,icons:[{icon:"/icon.svg",label:"Cut Deck",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/deck_data`],value:void 0,operator:"!=",coordinator:"&&"}],max:1}}],async onClick(c,e){for(const a of c.items){const t=a.metadata[`${h.EXTENSIONID}/deck_data`];if(t.Cards.length<=3)await s.notification.show("You need at least four cards to cut the deck.");else{const i=Math.ceil(t.Cards.length/2),o=t.Cards.slice(0,i),r=t.Cards.slice(i);await s.scene.items.updateItems(c.items,I=>{for(let C of I){const g=o[o.length-1],D=y(g.BackUrl);C.metadata[`${h.EXTENSIONID}/deck_data`]={Id:t.Id,Cards:o},C.image.url=g.BackUrl,C.image.mime=`image/${D}`,C.text.plainText=o.length.toString()}});const n=k.sceneItems.find(I=>I.attachedTo===a.id&&I.metadata[`${h.EXTENSIONID}/deck_id_lines`]!==void 0);await s.scene.items.updateItems(I=>I.id===n.id,I=>{for(let C of I)C.position={x:a.position.x,y:a.position.y+Math.min(o.length,75)}});const m={x:a.position.x+300,y:a.position.y},p={Cards:r,Id:r[0].DeckId},l=f.CreateDeck(r[p.Cards.length-1].BackUrl,p,m);s.scene.items.addItems(l)}}}}),await s.contextMenu.create({id:h.SHUFFLECARDSID,icons:[{icon:"/icon.svg",label:"Shuffle Cards",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/deck_data`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(c,e){await s.scene.items.updateItems(c.items,a=>{for(let t of a){const i=t.metadata[`${h.EXTENSIONID}/deck_data`];i.Cards=w(i.Cards);const o=i.Cards[i.Cards.length-1],r=y(o.BackUrl);t.image.url=o.BackUrl,t.image.mime=`image/${r}`}}),await s.notification.show("The deck has been shuffled.","DEFAULT")}}),await s.contextMenu.create({id:h.FLIPCARDID,icons:[{icon:"/icon.svg",label:"Flip Card",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/card_data`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(c,e){await s.scene.items.updateItems(c.items,a=>{for(let t of a){const i=t.metadata[`${h.EXTENSIONID}/card_data`],o=y(i.FaceUp===!0?i.BackUrl:i.FrontUrl);t.image.url=i.FaceUp===!0?i.BackUrl:i.FrontUrl,t.image.mime=`image/${o}`,i.FaceUp=i.FaceUp!==!0,t.metadata[`${h.EXTENSIONID}/card_data`]=i}})}}),await s.contextMenu.create({id:h.GROUPCARDSID,icons:[{icon:"/icon.svg",label:"Group Cards",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/card_data`],value:void 0,operator:"!=",coordinator:"&&"}],min:2}}],async onClick(c,e){const t=c.items[0].position,i=[];for(let n of c.items){const m=n.metadata[`${h.EXTENSIONID}/card_data`];m.FaceUp=!1,i.push(m)}const o={Cards:i,Id:i[0].DeckId},r=f.CreateDeck(i[o.Cards.length-1].BackUrl,o,t);s.scene.items.addItems(r),s.scene.items.deleteItems(c.items.map(n=>n.id))}}),await s.contextMenu.create({id:h.DRAWCARDID,icons:[{icon:"/icon.svg",label:"Draw Card",filter:{every:[{key:["metadata",`${h.EXTENSIONID}/deck_data`],value:void 0,operator:"!=",coordinator:"&&"}]}}],async onClick(c,e){const a=[];let t=300+S(10,35),i=0+S(10,35);for(const o of c.items){const r=o.metadata[`${h.EXTENSIONID}/deck_data`],n=r.Cards[r.Cards.length-1];if(n){const m=f.CreateCard(n.FrontUrl,n.BackUrl,n.Value,n.FaceUp,n.DeckId);if(m.position={x:o.position.x+t,y:o.position.y+i},a.push(m),r.Cards.length>2){await s.scene.items.updateItems(c.items,l=>{for(let I of l){const C=I.metadata[`${h.EXTENSIONID}/deck_data`];C.Cards.pop();const g=C.Cards[C.Cards.length-1],D=y(g.BackUrl);I.image.url=g.BackUrl,I.image.mime=`image/${D}`,I.text.plainText=C.Cards.length.toString()}});const p=k.sceneItems.find(l=>l.attachedTo===o.id&&l.metadata[`${h.EXTENSIONID}/deck_id_lines`]!==void 0);await s.scene.items.updateItems(l=>l.id===p.id,l=>{for(let I of l)I.position={x:o.position.x,y:o.position.y+Math.min(r.Cards.length,75)}})}else if(r.Cards.length===2){const p=r.Cards[0],l=f.CreateCard(p.FrontUrl,p.BackUrl,p.Value,p.FaceUp,p.DeckId);l.position={x:o.position.x,y:o.position.y},a.push(l),await s.scene.items.deleteItems(c.items.map(I=>I.id))}}}await s.scene.items.addItems(a)}})}document.querySelector("#app").innerHTML=`
  <div>
    Hello.
    <button id="makecard">Make a Card</button>
    <button id="makedeck">Make a Deck</button>
    <button id="makemajor">Make a Major</button>
    <button id="makeminor">Make a Minor</button>
    <button id="maked20">Make a D20</button>
  </div>
`;async function O(){await k.InitializeCache(),await f.InitializeDecked(),k.SetupHandlers()}s.onReady(async()=>{if(await s.scene.isReady()===!1){const e=s.scene.onReadyChange(async a=>{a&&(e(),await O())})}else await O()});class P{constructor(){}async Testing(){const e=document.getElementById("makedeck");e.onclick=async r=>{r.preventDefault();const n=f.PopulateDeck(d.BACK_ABSTRACT,d.DECK52,d.GETPNGURL),m=f.CreateDeck(n.Cards[0].BackUrl,n);s.scene.items.addItems(m)};const a=document.getElementById("makemajor");a.onclick=async r=>{r.preventDefault();const n=f.PopulateDeck(d.BACK_ASTRONAUT,d.TAROTMAJOR,d.GETWEBPURL),m=f.CreateDeck(n.Cards[0].BackUrl,n);s.scene.items.addItems(m)};const t=document.getElementById("makeminor");t.onclick=async r=>{r.preventDefault();const n=f.PopulateDeck(d.BACK_SCENE,d.TAROTMINOR,d.GETWEBPURL),m=f.CreateDeck(n.Cards[0].BackUrl,n);s.scene.items.addItems(m)};const i=document.getElementById("maked20");i.onclick=async r=>{r.preventDefault();const n=f.PopulateDeck(d.BACK_RED,d.DICECARDS,d.GETWEBPURL),m=f.CreateDeck(n.Cards[0].BackUrl,n);s.scene.items.addItems(m)};const o=document.getElementById("makecard");o.onclick=async r=>{r.preventDefault();const n=f.CreateCard(d.CLUBS_10,d.BACK_CLOUDS,"clubs_10",!0,R());s.scene.items.addItems([n])}}async InitializeDecked(){await v(),this.Testing()}CreateDeck(e,a,t){const i=a.Cards[0].BackUrl,o=y(i),r=M({height:d.HEIGHT,width:d.WIDTH,url:e,mime:`image/${o}`},{dpi:150,offset:{x:0,y:0}}).metadata({[`${h.EXTENSIONID}/deck_data`]:a}).name("Deck").plainText(a.Cards.length.toString()).layer("PROP").build();t&&(r.position=t);const n=[[E.MOVE,d.RADIUS,0],[E.LINE,d.WIDTH-d.RADIUS,0],[E.QUAD,d.WIDTH,0,d.WIDTH,d.RADIUS],[E.LINE,d.WIDTH,d.HEIGHT-d.RADIUS],[E.QUAD,d.WIDTH,d.HEIGHT,d.WIDTH-d.RADIUS,d.HEIGHT],[E.LINE,d.RADIUS,d.HEIGHT],[E.QUAD,0,d.HEIGHT,0,d.HEIGHT-d.RADIUS],[E.LINE,0,d.RADIUS],[E.QUAD,0,0,d.RADIUS,0],[E.CLOSE]];for(let p=0;p<20;p++){const l=d.HEIGHT-p*4;n.push([E.MOVE,d.WIDTH,l-d.RADIUS]),n.push([E.QUAD,d.WIDTH,l,d.WIDTH-d.RADIUS,l]),n.push([E.LINE,d.RADIUS,l]),n.push([E.QUAD,0,l,0,l-d.RADIUS])}const m=A().commands(n).strokeOpacity(1).strokeWidth(.85).strokeColor("#000000").fillColor("#ffffff").layer("PROP").metadata({[`${h.EXTENSIONID}/deck_id_lines`]:a.Id}).zIndex(.5).build();return m.position={x:r.position.x,y:r.position.y+Math.min(a.Cards.length,75)},m.attachedTo=r.id,m.disableHit=!0,[r,m]}CreateCard(e,a,t,i,o){const r=y(i?e:a),n={BackUrl:a,FrontUrl:e,FaceUp:i,Value:t,DeckId:o};return M({height:d.HEIGHT,width:d.WIDTH,url:i?e:a,mime:`image/${r}`},{dpi:150,offset:{x:0,y:0}}).metadata({[`${h.EXTENSIONID}/card_data`]:n}).name("Card").layer("PROP").build()}PopulateDeck(e,a,t){const i=[],o=R();for(const n of a){const m={BackUrl:e,FrontUrl:t(n),DeckId:o,FaceUp:!1,Value:n};i.push(m)}return{Id:o,Cards:i}}}const f=new P;
